---
# Main task file for OpenStack Janitor
# Checks if at least one component is enabled before proceeding

- name: Determine if any Janitor component is enabled
  ansible.builtin.set_fact:
    _os_janitor_any_enabled: >-
      {% set ns = namespace(enabled=false) %}
      {% for component in os_janitor_components_map.keys() %}
        {% set var_name = 'os_janitor_enable_' + component %}
        {% if hostvars[inventory_hostname].get(var_name, False) | bool %}
          {% set ns.enabled = true %}
        {% endif %}
      {% endfor %}
      {{ ns.enabled }}

- name: Display Janitor status
  ansible.builtin.debug:
    msg: "OpenStack Janitor enabled: {{ _os_janitor_any_enabled }}. (Set 'os_janitor_enable_<component>: true' to enable)"

- name: Deploy Janitor script and configuration
  block:
    - name: Import deployment script tasks
      ansible.builtin.import_tasks: deploy_script.yml
    - name: Import deployment timer tasks
      ansible.builtin.import_tasks: deploy_timers.yml
  when: _os_janitor_any_enabled | bool
