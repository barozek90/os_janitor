---
# Main task file for OpenStack Janitor
# Checks if at least one component is enabled before proceeding

- name: Determine Janitor status on this host
  ansible.builtin.set_fact:
    # Check if any component is enabled (to decide if role tasks should run)
    _os_janitor_any_enabled: >-
      {%- set ns = namespace(enabled=false) -%}
      {%- for component in os_janitor_components_map.keys() -%}
        {%- set var_name = 'os_janitor_enable_' + component -%}
        {%- if hostvars[inventory_hostname].get(var_name, False) | bool -%}
          {%- set ns.enabled = true -%}
        {%- endif -%}
      {%- endfor -%}
      {{ ns.enabled }}

    # Check if THIS host is the primary node for any enabled component (HA logic)
    _os_janitor_active_on_host: >-
      {%- set ns = namespace(active=false) -%}
      {%- for component, details in os_janitor_components_map.items() -%}
        {%- set var_name = 'os_janitor_enable_' + component -%}
        {%- set is_enabled = hostvars[inventory_hostname].get(var_name, False) | bool -%}
        {%- set group_name = details.group | default('control') -%}
        {%- if is_enabled and group_name in groups and inventory_hostname == groups[group_name][0] -%}
          {%- set ns.active = true -%}
        {%- endif -%}
      {%- endfor -%}
      {{ ns.active }}

- name: Display Janitor status
  ansible.builtin.debug:
    msg: 
      - "Role Enabled: {{ _os_janitor_any_enabled | bool }}"
      - "Active on this host (HA): {{ _os_janitor_active_on_host | bool }}"

- name: Clean up Janitor installation (if disabled)
  block:
    - name: Import cleanup tasks
      ansible.builtin.import_tasks: cleanup.yml
  when: not (_os_janitor_any_enabled | bool)

- name: Deploy Janitor script and configuration (if enabled)
  block:
    - name: Import deployment script tasks
      ansible.builtin.import_tasks: deploy_script.yml
    - name: Import deployment timer tasks
      ansible.builtin.import_tasks: deploy_timers.yml
  when: _os_janitor_any_enabled | bool

