#!/bin/bash
#
# OpenStack Database Janitor Script
# Managed by Ansible role: os_janitor
#
# Usage: $0 [--all | --component_name]
#
# Generated for host: {{ inventory_hostname }}
# Only cleanups assigned to this host (first node of defined group) will be executed.
#

LOG_FILE="{{ os_janitor_log_dir }}/janitor.log"
RETENTION_DAYS="{{ os_janitor_retention_days }}"
DATE_LIMIT=$(date -d "${RETENTION_DAYS} days ago" +%Y-%m-%d)
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

# Ensure log directory exists
mkdir -p $(dirname "$LOG_FILE")

log() {
    echo "[$TIMESTAMP] $1" | tee -a "$LOG_FILE"
}

check_container() {
    local container_name=$1
    if ! docker ps --format '{{"{{.Names}}"}}' | grep -q "^${container_name}$"; then
        log "SKIP: Container '${container_name}' not running on this host."
        return 1
    fi
    return 0
}

# --- Cleanup Functions ---
{% for component, details in os_janitor_components_map.items() %}
{% set is_enabled = hostvars[inventory_hostname].get('os_janitor_enable_' + component, False) | bool %}
{% if is_enabled %}
clean_{{ component }}() {
    local container="{{ details.container }}"
    log "START: Cleaning {{ component | upper }} (Container: $container, Retention: $RETENTION_DAYS days)"

    if ! check_container "$container"; then
        return
    fi

    {% for cmd in details.cmds %}
    # Prepare command: Replace placeholders
    CMD="{{ cmd }}"
    CMD=${CMD//__DAYS__/$RETENTION_DAYS}
    CMD=${CMD//__DATE_LIMIT__/$DATE_LIMIT}

    log "EXEC: docker exec $container $CMD"
    if docker exec "$container" $CMD >> "$LOG_FILE" 2>&1; then
        log "SUCCESS: {{ component | upper }} clean step completed."
    else
        log "ERROR: {{ component | upper }} clean step failed. Check log above."
    fi
    {% endfor %}
    
    log "END: {{ component | upper }} cleanup finished."
}
{% endif %}
{% endfor %}

usage() {
    echo "Usage: $0 [--all] [component_flags]"
    echo "Available flags:"
    echo "  --all : Run cleanup for all enabled components assigned to this host"
    {% for component in os_janitor_components_map.keys() %}
    {% set is_enabled = hostvars[inventory_hostname].get('os_janitor_enable_' + component, False) | bool %}
    {% if is_enabled %}
    echo "  --{{ component }} : Run cleanup for {{ component }}"
    {% endif %}
    {% endfor %}
}

if [ $# -eq 0 ]; then
    usage
    exit 1
fi

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --all)
            log "START: Running ALL assigned cleanups for this host"
            {% for component, details in os_janitor_components_map.items() %}
            {% set is_enabled = hostvars[inventory_hostname].get('os_janitor_enable_' + component, False) | bool %}
            {% set group_name = details.group | default('control') %}
            {% if is_enabled %}
            # Check HA assignment for {{ component }} (Group: {{ group_name }})
            {% if group_name in groups and inventory_hostname in groups[group_name] and inventory_hostname == groups[group_name][0] %}
            clean_{{ component }}
            {% else %}
            # Skipped: This host is not the primary node for group '{{ group_name }}'
            {% endif %}
            {% endif %}
            {% endfor %}
            log "END: Finished ALL assigned cleanups"
            shift
            ;;
        {% for component, details in os_janitor_components_map.items() %}
        {% set is_enabled = hostvars[inventory_hostname].get('os_janitor_enable_' + component, False) | bool %}
        {% if is_enabled %}
        --{{ component }})
            clean_{{ component }}
            shift
            ;;
        {% endif %}
        {% endfor %}
        *)
            log "Unknown argument: $1"
            usage
            exit 1
            ;;
    esac
done
